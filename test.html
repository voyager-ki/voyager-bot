<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voyager AI - Chat</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter and Playfair Display -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <!-- Leaflet Map Library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        /* Applying the Inter font family globally */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark grey background */
        }
        
        /* Custom font class for the new title font */
        .font-playfair {
            font-family: 'Playfair Display', serif;
        }
        
        /* --- Animation Keyframes --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Animation is now in a separate class for dynamic application */
        .new-message-animation {
            animation: fadeIn 0.5s ease-in-out;
        }

        /* Blinking cursor for typing indicator */
        @keyframes blink {
            50% { opacity: 0; }
        }
        .blinking-cursor {
            animation: blink 1s step-start infinite;
        }

        /* Style for the map container */
        #map {
            height: 500px;
            border-radius: 0.5rem;
        }

        /* --- Glassmorphism Helper Class --- */
        .glass-effect {
            background-color: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .restaurant-item.glass-effect:hover {
            background-color: rgba(255, 255, 255, 0.8);
        }
        .glass-effect-ai-bubble {
            background-color: rgba(229, 231, 235, 0.7); /* Light gray base for AI bubbles */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .glass-effect-dark {
             background-color: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* --- List Fade Effect --- */
        .list-fade-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2rem; /* 32px */
            background: linear-gradient(to bottom, rgba(249, 250, 251, 0.8), transparent);
            z-index: 10;
            pointer-events: none; /* Allows scrolling through the gradient */
        }

        .list-fade-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2rem; /* 32px */
            background: linear-gradient(to top, rgba(249, 250, 251, 0.8), transparent);
            z-index: 10;
            pointer-events: none; /* Allows scrolling through the gradient */
        }
    </style>
</head>
<body class="antialiased">
    
    <div class="p-0 md:p-8 flex items-center justify-center min-h-screen">
        <div id="chat-container" class="relative flex flex-col w-full max-w-4xl md:h-[95vh] md:max-h-[1000px] md:rounded-2xl md:shadow-2xl md:overflow-hidden bg-gray-100">
            <!-- Chat Header -->
            <header id="chat-header" class="glass-effect p-4 shadow-sm opacity-0 transition-opacity duration-500 flex-shrink-0">
                <div class="flex items-center">
                    <svg class="h-8 w-8 text-slate-800 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9 9 0 100-18 9 9 0 000 18z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 8.25L12 15.75l-3.75-7.5L12 3l3.75 5.25z" />
                    </svg>
                    <h1 class="font-playfair text-2xl font-bold text-slate-900">Voyager AI</h1>
                </div>
            </header>

            <!-- Chat Messages Area -->
            <main id="chat-messages" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6">
                <!-- Messages will be dynamically added here -->
            </main>

            <!-- Chat Input Area -->
            <footer id="chat-footer" class="glass-effect p-4 opacity-0 transition-opacity duration-500 flex-shrink-0">
                <div id="chat-input-container" class="relative w-full">
                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-4">
                        <svg class="h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <input id="chat-input" type="text" value="Find me recommendations for restaurants in Kyoto" class="block w-full rounded-full border-0 bg-white/75 py-3.5 pl-11 pr-16 text-gray-900 ring-1 ring-inset ring-gray-900/10 placeholder:text-gray-600 focus:ring-2 focus:ring-inset focus:ring-black sm:text-sm sm:leading-6" disabled>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-1.5">
                        <button id="send-button" type="button" class="inline-flex items-center justify-center rounded-full bg-black h-9 w-9 text-sm font-semibold text-white shadow-sm hover:bg-gray-800 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-black transition-colors duration-300">
                            <span class="sr-only">Send</span>
                            <!-- Corrected Send Icon to a right arrow -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <script>
        // --- DOM Element References ---
        const chatContainer = document.getElementById('chat-container');
        const chatHeader = document.getElementById('chat-header');
        const chatFooter = document.getElementById('chat-footer');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');

        // --- Fictional Data with Coordinates Clustered in Downtown Kyoto ---
        const restaurantData = [
            { id: 0, name: "Gion Izakaya", cuisine: "Izakaya", rating: 4.7, description: "Lively spot with classic small plates and an extensive sake list.", lat: 35.0037, lng: 135.7783 },
            { id: 1, name: "Kaze Arashiyama", cuisine: "Kaiseki", rating: 4.9, description: "Authentic multi-course dining with serene bamboo garden views.", lat: 35.0042, lng: 135.7751 },
            { id: 2, name: "Fushimi Sake House", cuisine: "Japanese Fusion", rating: 4.5, description: "Modern dishes paired perfectly with locally brewed sake.", lat: 35.0061, lng: 135.7689 },
            { id: 3, name: "Kyoto Ramen Kitchen", cuisine: "Ramen", rating: 4.6, description: "Rich, flavorful broth and perfectly chewy noodles in a cozy setting.", lat: 35.0011, lng: 135.7681 },
            { id: 4, name: "Pontocho Tempura", cuisine: "Tempura", rating: 4.8, description: "Exquisitely light and crispy tempura served right on the Kamo River.", lat: 35.0058, lng: 135.7715 },
            { id: 5, name: "Nishiki Market Sushi", cuisine: "Sushi", rating: 4.7, description: "The freshest cuts of fish sourced directly from the historic market.", lat: 35.0049, lng: 135.7657 },
            { id: 6, name: "Higashiyama Tofu", cuisine: "Shojin Ryori", rating: 4.4, description: "Elegant vegetarian Buddhist cuisine featuring artisanal tofu.", lat: 35.0023, lng: 135.7795 },
            { id: 7, name: "Kinkaku-ji Udon", cuisine: "Udon", rating: 4.3, description: "Hearty, handmade udon noodles with a view of the Golden Pavilion.", lat: 35.0081, lng: 135.7672 },
            { id: 8, name: "Philosopher's Path Cafe", cuisine: "Cafe & Sweets", rating: 4.6, description: "A tranquil retreat for matcha, wagashi, and quiet contemplation.", lat: 35.0095, lng: 135.7748 },
            { id: 9, name: "Miyako Soba", cuisine: "Soba", rating: 4.5, description: "Handmade buckwheat noodles served hot or cold with delicate sauces.", lat: 35.0088, lng: 135.7640 },
            { id: 10, name: "Imperial Garden Teppanyaki", cuisine: "Teppanyaki", rating: 4.9, description: "Master chefs perform culinary artistry on iron griddles.", lat: 35.0076, lng: 135.7625 },
            { id: 11, name: "Yasaka Pagoda Yakitori", cuisine: "Yakitori", rating: 4.7, description: "Perfectly grilled skewers enjoyed in the historic Yasaka district.", lat: 35.0015, lng: 135.7788 },
            { id: 12, name: "Kurama Mountain Onsen Ryori", cuisine: "Ryori", rating: 4.8, description: "Traditional mountain cuisine served after a relaxing onsen bath.", lat: 35.0005, lng: 135.7719 },
            { id: 13, name: "Shijo Street Okonomiyaki", cuisine: "Okonomiyaki", rating: 4.4, description: "Savory pancakes cooked to perfection on a tabletop grill.", lat: 35.0046, lng: 135.7695 },
            { id: 14, name: "The Kyoto Grill", cuisine: "Wagyu Steak", rating: 5.0, description: "Experience the ultimate melt-in-your-mouth A5 Wagyu beef.", lat: 35.0025, lng: 135.7730 },
            { id: 15, name: "Uji Matcha House", cuisine: "Desserts", rating: 4.8, description: "A paradise for matcha lovers, from parfaits to rich ice cream.", lat: 35.0066, lng: 135.7662 },
            { id: 16, name: "Kiyomizu-dera Tea House", cuisine: "Tea & Snacks", rating: 4.6, description: "Enjoy traditional tea with stunning views of the city below.", lat: 35.0019, lng: 135.7801 },
            { id: 17, name: "Arashiyama Monkey Park Eatery", cuisine: "Light Meals", rating: 4.1, description: "Simple, delicious bites to refuel after a hike with the monkeys.", lat: 35.0073, lng: 135.7764 },
            { id: 18, name: "Gekkeikan Okura Kushiage", cuisine: "Kushiage", rating: 4.5, description: "Deep-fried skewers of meat and vegetables with creative dipping sauces.", lat: 35.0033, lng: 135.7650 },
            { id: 19, name: "Nijo Castle Dining", cuisine: "Kaiseki", rating: 4.7, description: "Dine like a shogun with refined dishes in a historic setting.", lat: 35.0052, lng: 135.7632 },
            { id: 20, name: "Kyoto Station Curry", cuisine: "Japanese Curry", rating: 4.3, description: "Quick, satisfying, and deeply flavorful curry rice for travelers.", lat: 35.0009, lng: 135.7657 },
            { id: 21, name: "Tofuku-ji Temple Soba", cuisine: "Soba", rating: 4.6, description: "A quiet spot known for its delicious soba and beautiful autumn views.", lat: 35.0028, lng: 135.7703 },
            { id: 22, name: "Kamo River BBQ", cuisine: "Yakiniku", rating: 4.5, description: "Grill your own premium cuts of meat while enjoying the riverside ambiance.", lat: 35.0060, lng: 135.7700 },
            { id: 23, name: "Fushimi Inari Fox Cafe", cuisine: "Themed Cafe", rating: 4.2, description: "Adorable fox-themed lattes and snacks near the famous torii gates.", lat: 35.0018, lng: 135.7767 }
        ];

        let map;
        let markers = {};

        /**
         * Scrolls the chat window to the bottom.
         */
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        /**
         * Appends a user's message to the chat.
         * @param {string} message - The text of the message.
         */
        function addUserMessage(message) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'chat-message new-message-animation flex items-start gap-3 justify-end';
            messageWrapper.innerHTML = `
                <div class="glass-effect-dark text-white rounded-lg p-4 max-w-lg">
                    <p>${message}</p>
                </div>
                <div class="flex-shrink-0 h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                    <svg class="h-6 w-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" /></svg>
                </div>
            `;
            chatMessages.appendChild(messageWrapper);
            scrollToBottom();
        }
        
        /**
         * Appends the initial AI welcome message.
         */
        function addInitialAiMessage() {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'chat-message new-message-animation flex items-start gap-3';
            messageWrapper.innerHTML = `
                <div class="flex-shrink-0 h-10 w-10 rounded-full bg-slate-200 flex items-center justify-center">
                    <svg class="h-6 w-6 text-slate-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9 9 0 100-18 9 9 0 000 18z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 8.25L12 15.75l-3.75-7.5L12 3l3.75 5.25z" />
                    </svg>
                </div>
                <div class="glass-effect-ai-bubble rounded-lg p-4 max-w-lg">
                    <p class="text-gray-900">Hello! I'm Voyager AI. How can I help you plan your trip today?</p>
                </div>
            `;
            chatMessages.appendChild(messageWrapper);
        }

        /**
         * Shows a typing indicator for the AI.
         * @returns {HTMLElement} - The typing indicator element.
         */
        function showTypingIndicator() {
            const indicatorWrapper = document.createElement('div');
            indicatorWrapper.id = 'typing-indicator';
            indicatorWrapper.className = 'chat-message new-message-animation flex items-start gap-3';
            indicatorWrapper.innerHTML = `
                <div class="flex-shrink-0 h-10 w-10 rounded-full bg-slate-200 flex items-center justify-center">
                    <svg class="h-6 w-6 text-slate-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9 9 0 100-18 9 9 0 000 18z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 8.25L12 15.75l-3.75-7.5L12 3l3.75 5.25z" />
                    </svg>
                </div>
                <div>
                    <div class="glass-effect-ai-bubble rounded-lg p-4 inline-block">
                        <div class="flex items-center justify-center space-x-1">
                            <span class="h-2 w-2 bg-gray-600 rounded-full blinking-cursor" style="animation-delay: 0s;"></span>
                            <span class="h-2 w-2 bg-gray-600 rounded-full blinking-cursor" style="animation-delay: 0.2s;"></span>
                            <span class="h-2 w-2 bg-gray-600 rounded-full blinking-cursor" style="animation-delay: 0.4s;"></span>
                        </div>
                    </div>
                    <p class="text-sm text-gray-700 mt-2 ml-1">Preparing recommendations...</p>
                </div>
            `;
            chatMessages.appendChild(indicatorWrapper);
            scrollToBottom();
            return indicatorWrapper;
        }

        /**
         * Appends the AI's final response with the map widget.
         */
        function addAiResponse() {
            const responseWrapper = document.createElement('div');
            responseWrapper.className = 'chat-message new-message-animation flex items-start gap-3';
            
            let listHtml = '';
            restaurantData.forEach(resto => {
                listHtml += `
                    <div class="restaurant-item glass-effect rounded-lg p-4 cursor-pointer shadow-sm" data-id="${resto.id}">
                        <h3 class="text-lg font-semibold text-gray-900">${resto.name}</h3>
                        <p class="text-sm font-medium text-gray-800 mt-1">${resto.cuisine}</p>
                        <div class="flex items-center mt-3">
                            ${createStarRating(resto.rating)}
                            <span class="ml-2 text-sm text-gray-900 font-medium">${resto.rating.toFixed(1)}</span>
                        </div>
                        <p class="text-gray-800 mt-2 text-sm">${resto.description}</p>
                    </div>
                `;
            });

            responseWrapper.innerHTML = `
                <div class="flex-shrink-0 h-10 w-10 rounded-full bg-slate-200 flex items-center justify-center">
                    <svg class="h-6 w-6 text-slate-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9 9 0 100-18 9 9 0 000 18z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 8.25L12 15.75l-3.75-7.5L12 3l3.75 5.25z" />
                    </svg>
                </div>
                <div class="glass-effect-ai-bubble rounded-lg p-4 space-y-4 w-full max-w-4xl">
                    <p class="text-gray-900">Of course! Here are some restaurant recommendations for Kyoto.</p>
                    <div class="md:grid md:grid-cols-2 md:gap-4">
                        <div class="relative list-fade-container">
                            <div class="overflow-y-auto h-[500px] pr-2 space-y-4">${listHtml}</div>
                        </div>
                        <div class="hidden md:block" id="map"></div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(responseWrapper);
            
            // THE FIX: Delay map initialization slightly to ensure the container is rendered
            setTimeout(() => {
                initializeMapAndInteractions();
            }, 50);
        }

        /**
         * Initializes the Leaflet map and adds markers and hover events.
         */
        function initializeMapAndInteractions() {
            map = L.map('map');
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            const defaultIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-black.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                shadowSize: [41, 41]
            });

            const highlightedIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                iconSize: [35, 57],
                iconAnchor: [17, 57],
                popupAnchor: [1, -44],
                shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                shadowSize: [57, 57]
            });

            const markerGroup = [];
            restaurantData.forEach(resto => {
                const marker = L.marker([resto.lat, resto.lng], { icon: defaultIcon }).addTo(map)
                    .bindPopup(`<b>${resto.name}</b><br>${resto.cuisine}`);
                markers[resto.id] = marker;
                markerGroup.push(marker);
            });
            
            const group = new L.featureGroup(markerGroup);
            map.fitBounds(group.getBounds().pad(0.1));


            document.querySelectorAll('.restaurant-item').forEach(item => {
                const id = item.getAttribute('data-id');
                const marker = markers[id];

                item.addEventListener('mouseover', () => {
                    if (marker) {
                        marker.setIcon(highlightedIcon);
                    }
                });

                item.addEventListener('mouseout', () => {
                    if (marker) {
                        marker.setIcon(defaultIcon);
                    }
                });

                item.addEventListener('click', () => {
                    if (marker) {
                        map.panTo(marker.getLatLng());
                        marker.openPopup();
                    }
                });
            });
        }

        /**
         * Generates the SVG icons for the star rating.
         */
        function createStarRating(rating) {
            let starsHtml = '<div class="flex items-center">';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    starsHtml += `<svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/></svg>`;
                } else if (i - 0.5 <= rating) {
                    starsHtml += `<svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0v15z"/></svg>`;
                } else {
                    starsHtml += `<svg class="w-5 h-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/></svg>`;
                }
            }
            starsHtml += '</div>';
            return starsHtml;
        }

        /**
         * Main application logic to handle the chat flow.
         */
        function handleSend() {
            const message = chatInput.value;
            if (!message || message === '...') return;

            addUserMessage(message);

            chatInput.disabled = true;
            sendButton.disabled = true;
            chatInput.value = '...';
            
            setTimeout(() => {
                const typingIndicator = showTypingIndicator();

                setTimeout(() => {
                    typingIndicator.remove();
                    addAiResponse();
                }, 8000);
            }, 600); 
        }

        // --- Initial Load Animation ---
        document.addEventListener('DOMContentLoaded', () => {
            // Fade in the main UI elements
            setTimeout(() => {
                chatHeader.classList.remove('opacity-0');
                chatFooter.classList.remove('opacity-0');
            }, 200);

            // Add the initial AI message after a delay
            setTimeout(() => {
                addInitialAiMessage();
            }, 600);

            sendButton.addEventListener('click', handleSend);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSend();
                }
            });
        });

    </script>
</body>
</html>
